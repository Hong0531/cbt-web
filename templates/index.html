<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ CBT</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
<div class="main">
    <!-- âœ… ë¡œê·¸ì¸ ì—¬ë¶€ -->
    <div style="text-align: right; margin-bottom: 20px;">
        {% if user_name %}
        <p style="margin: 0;">ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, <strong>{{ user_name }}</strong>ë‹˜</p>
        <p style="margin: 4px 0;">
            <a href="{{ url_for('records') }}" style="text-decoration: none;">ğŸ“„ ì‹œí—˜ ê¸°ë¡ ë³´ê¸°</a>
        </p>
        <form action="/logout" method="get" style="display: inline;">
            <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
        {% else %}
        <form action="/login" method="get">
            <button type="submit">â† ë’¤ë¡œê°€ê¸°</button>
        </form>
        {% endif %}
    </div>

    <h2>ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ CBT ëª¨ì˜ê³ ì‚¬</h2>

    <div id="start-panel">
        <p>ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
        <button onclick="startQuiz('practice')">ì—°ìŠµëª¨ë“œ</button>
        <button onclick="startQuiz('exam')">ì‹œí—˜ëª¨ë“œ</button>
    </div>

    <div id="timer">90:00</div>
    <div id="quiz-container" style="display:none;"></div>
    <div id="controls" style="display:none;">
        <button onclick="confirmFinish()">ì‹œí—˜ ì¢…ë£Œ</button>
        <button onclick="returnToStart()">ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘</button>
    </div>
    <div id="result"></div>
</div>

<div id="nav-panel">
    <strong>ë¬¸ì œ ì´ë™</strong>
    <div id="question-buttons"></div>
</div>

<script>
let currentQuestion = 0;
let time = 90 * 60;
let timerInterval;
let userAnswers = [];
const questions = [];
let mode = 'exam';
let submitted = false;  // âœ… ì¤‘ë³µ ì œì¶œ ë°©ì§€ ë³€ìˆ˜

function startQuiz(selectedMode) {
    mode = selectedMode;
    document.getElementById('start-panel').style.display = 'none';
    document.getElementById('quiz-container').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    document.getElementById('nav-panel').style.display = 'block';
    document.getElementById('timer').style.display = (mode === 'exam') ? 'block' : 'none';
    userAnswers = new Array(questions.length).fill(null);
    submitted = false; // âœ… ë‹¤ì‹œ ì‹œì‘ ì‹œ ì´ˆê¸°í™”
    renderQuestion(0);
    renderNavButtons();
    if (mode === 'exam') startTimer();
}

function returnToStart() {
    clearInterval(timerInterval);
    submitted = false;
    document.getElementById('start-panel').style.display = 'block';
    document.getElementById('quiz-container').style.display = 'none';
    document.getElementById('controls').style.display = 'none';
    document.getElementById('nav-panel').style.display = 'none';
    document.getElementById('timer').style.display = 'none';
    document.getElementById('result').innerHTML = '';
}

function startTimer() {
    timerInterval = setInterval(() => {
        const m = String(Math.floor(time / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${m}:${s}`;
        time--;
        if (time < 0) {
        clearInterval(timerInterval);
        finishQuiz();
        }
    }, 1000);
}

function renderQuestion(index) {
    const q = questions[index];
    currentQuestion = index;
    const selected = userAnswers[index];
    document.getElementById('quiz-container').innerHTML = `
        <div id="question-${index + 1}" class="question-box">
        <h3>ë¬¸ì œ ${index + 1} / ${questions.length}</h3>
        <p>${q.question}</p>
        <div class="options">
            ${q.options.map((opt, i) => `
            <label><input type="radio" name="option" value="${i}" ${selected == i ? "checked" : ""}> ${i + 1}. ${opt}</label>
            `).join('')}
        </div>
        ${mode === 'practice' ? `<button onclick="toggleExplanation(${index})">í•´ì„¤ ë³´ê¸°</button><div id="exp-${index}" class="explanation">${q.explanation || 'í•´ì„¤ ì—†ìŒ'}</div>` : ''}
        </div>
        <div>
        ${index > 0 ? `<button onclick="renderQuestion(${index - 1})">ì´ì „</button>` : ''}
        ${index < questions.length - 1 ? `<button onclick="saveAnswerAndNext(${index})">ë‹¤ìŒ</button>` : '<button onclick="finishQuiz()">ì œì¶œ</button>'}
        </div>
    `;
    document.querySelectorAll('input[name="option"]').forEach(input => {
        input.addEventListener('change', e => {
        userAnswers[index] = parseInt(e.target.value);
        updateNavButton(index);
        });
    });
}

function toggleExplanation(index) {
    const exp = document.getElementById(`exp-${index}`);
    if (exp) exp.style.display = exp.style.display === 'block' ? 'none' : 'block';
}

function saveAnswerAndNext(index) {
    updateNavButton(index);
    renderQuestion(index + 1);
}

function confirmFinish() {
    if (confirm("ì •ë§ ì‹œí—˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        finishQuiz();
    }
}

function finishQuiz() {
    clearInterval(timerInterval);

    if (submitted) return;  // âœ… ì¤‘ë³µ ì œì¶œ ì°¨ë‹¨
    submitted = true;

    let score = 0;
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = '';

    const subjectScores = [0, 0, 0];
    const subjectCounts = [0, 0, 0];

    questions.forEach((q, i) => {
        const correct = q.answer;
        const user = userAnswers[i];
        const isAnswered = (user !== undefined && user !== null);
        const isCorrect = isAnswered && (user + 1) === correct;
        const correctText = `${correct}. ${q.options[correct - 1]}`;
        const userText = isAnswered ? `${user + 1}. ${q.options[user]}` : 'ë¯¸ì‘ë‹µ';
        const subjectIndex = Math.floor(i / 20);

        if (isCorrect) score++, subjectScores[subjectIndex]++;
        subjectCounts[subjectIndex]++;

        resultContainer.innerHTML += `
        <div style='margin-bottom:8px;'>
            <strong>ë¬¸ì œ ${i + 1}</strong><br>
            ë‹¹ì‹ ì˜ ë‹µ: ${userText}<br>
            ${isCorrect ? '<span style="color:green">ì •ë‹µì…ë‹ˆë‹¤!</span>' : `<span style="color:red">í‹€ë ¸ìŠµë‹ˆë‹¤. ì •ë‹µ: ${correctText}</span>`}<br>
            <em style="color:gray;">í•´ì„¤: ${q.explanation || 'í•´ì„¤ ì—†ìŒ'}</em>
        </div>
        `;
    });

    const subjectResults = subjectScores.map((s, i) => {
        const total = subjectCounts[i];
        const percentage = Math.round((s / total) * 100);
        return `ê³¼ëª© ${i + 1}: ${percentage}ì `;
    });

    const totalScore = Math.round((score / questions.length) * 100);
    const isPassed = subjectScores.every((s, i) => (s / subjectCounts[i]) * 100 >= 40) && totalScore >= 60;
    const passMessage = isPassed
        ? "<span style='color:green; font-weight:bold;'>í•©ê²©ì…ë‹ˆë‹¤! ğŸ‰</span>"
        : "<span style='color:red; font-weight:bold;'>ë¶ˆí•©ê²©ì…ë‹ˆë‹¤.</span>";

    resultContainer.innerHTML += `
        <hr>
        <strong>ì´ì : ${totalScore}ì </strong><br>
        ${subjectResults.join('<br>')}<br><br>
        ${passMessage}
    `;

    if (mode === 'exam') {
        fetch("/api/submit", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            answers: userAnswers,
            mode: mode
        })
        })
        .then(res => res.json())
        .then(data => {
        console.log("âœ… ì„œë²„ ì‘ë‹µ:", data);
        })
        .catch(err => {
        console.error("âŒ ì œì¶œ ì‹¤íŒ¨:", err);
        });
    }
}

function renderNavButtons() {
    const nav = document.getElementById('question-buttons');
    nav.innerHTML = '';
    questions.forEach((_, i) => {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.onclick = () => renderQuestion(i);
        btn.style.backgroundColor = userAnswers[i] === undefined || userAnswers[i] === null ? '#ddd' : '#cce5ff';
        nav.appendChild(btn);
    });
}

function updateNavButton(index) {
    const nav = document.getElementById('question-buttons');
    const btn = nav.children[index];
    if (btn) {
        btn.style.backgroundColor = userAnswers[index] === undefined || userAnswers[index] === null ? '#ddd' : '#cce5ff';
    }
}

fetch("/api/questions")
    .then(res => res.json())
    .then(data => {
        questions.push(...data);
        console.log("ë¬¸ì œ ìˆ˜:", questions.length);
    })
    .catch(err => console.error("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err));
</script>
</body>
</html>
