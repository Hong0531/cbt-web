<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ CBT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>
        const SUBJECT = "{{ subject }}";
        const VERSION = "{{ version }}";
    </script>
</head>

<body>
<div id="user-panel">
    {% if user_name %}
        <p>ğŸ‘‹ <strong>{{ user_name }}</strong>ë‹˜</p>
        {% if user_name != "ê²ŒìŠ¤íŠ¸" %}
            <p style="margin-top:4px; font-size:13px;">
                <a href="{{ url_for('records') }}">ğŸ“„ ê¸°ë¡ ë³´ê¸°</a>
            </p>
        {% endif %}
        <form action="/logout" method="get" style="display:inline-block;margin-top:6px">
            <button class="btn-text" type="submit">ë¡œê·¸ì•„ì›ƒ</button>
        </form>
    {% else %}
        <form action="/login" method="get">
            <button type="submit">â† ë’¤ë¡œê°€ê¸°</button>
        </form>
    {% endif %}
</div>

<div class="main">
    <h2 class="page-title exam-title">ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ CBT</h2>

    <div id="start-panel">
        <p>ì‹œí—˜ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="start-actions">
            <button class="btn btn-secondary start-btn" onclick="startQuiz('practice')">
                ğŸ“ ì—°ìŠµ ëª¨ë“œ
                <div style="font-size:12px; font-weight:400; margin-top:4px;">í•´ì„¤ì„ ë³´ë©° í•™ìŠµí•©ë‹ˆë‹¤</div>
            </button>
            <button class="btn btn-primary start-btn" onclick="startQuiz('exam')">
                â±ï¸ ì‹¤ì „ ëª¨ë“œ
                <div style="font-size:12px; font-weight:400; margin-top:4px; opacity:0.9">ì‹¤ì œ ì‹œí—˜ê³¼ ë™ì¼í•©ë‹ˆë‹¤</div>
            </button>
        </div>
    </div>

    <div class="exam-layout" id="exam-view" style="display:none;">
        <aside class="exam-right">
            <div class="right-panel-inner">
                <div id="timer" class="timer" style="display:none">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span id="timer-text">90:00</span>
                </div>

                <div id="nav-panel">
                    <div style="font-size:14px; font-weight:700; color:#64748b; margin-bottom:8px;">ë¬¸ì œ ì´ë™ (OMR)</div>
                    <div id="question-buttons"></div>
                </div>
            </div>
        </aside>

        <div class="exam-left">
            <div id="quiz-container" style="display:none;"></div>
            
            <div id="controls" style="display:none; margin-top: 30px; text-align: center;">
                <button class="btn btn-secondary" onclick="returnToStart()" style="margin-right:10px;">ë‚˜ê°€ê¸°</button>
                <button class="btn btn-primary" onclick="confirmFinish()">ìµœì¢… ì œì¶œ</button>
            </div>
            <div id="result"></div>
        </div>
    </div>
</div>

<script>
let currentQuestion = 0;
let time = 90 * 60;
let timerInterval;
let userAnswers = [];
const questions = [];
let mode = 'exam';
let submitted = false;
const STORAGE_KEY = `cbt_progress_${SUBJECT}_${VERSION}`;

// --- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê´€ë ¨ í•¨ìˆ˜ ---
function saveState() {
    if (mode === 'exam' && !submitted) {
        const state = {
            answers: userAnswers,
            time: time,
            currentQuestion: currentQuestion,
            timestamp: new Date().getTime()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
}

function loadState() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const state = JSON.parse(saved);
        // 12ì‹œê°„ ì§€ë‚œ ë°ì´í„°ëŠ” íê¸°
        if (new Date().getTime() - state.timestamp > 12 * 60 * 60 * 1000) {
            localStorage.removeItem(STORAGE_KEY);
            return false;
        }
        return state;
    }
    return false;
}

function clearState() {
    localStorage.removeItem(STORAGE_KEY);
}

// --- ë©”ì¸ ë¡œì§ ---

function startQuiz(selectedMode) {
    mode = selectedMode;
    
    // UI ì „í™˜
    document.getElementById('start-panel').style.display = 'none';
    document.querySelector('.exam-title').style.display = 'none'; // ì œëª© ìˆ¨ê¹€ìœ¼ë¡œ ê³µê°„ í™•ë³´
    document.getElementById('exam-view').style.display = 'flex';
    document.getElementById('quiz-container').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    
    // ì €ì¥ëœ ì§„í–‰ ìƒí™© í™•ì¸
    const savedState = loadState();
    
    if (mode === 'exam' && savedState && confirm("ì´ì „ ì‹œí—˜ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ í‘¸ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        userAnswers = savedState.answers;
        time = savedState.time;
        currentQuestion = savedState.currentQuestion;
        // ë°°ì—´ ê¸¸ì´ê°€ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ(ë¬¸ì œ ì—…ë°ì´íŠ¸ ë“±) ì²´í¬
        if(userAnswers.length !== questions.length) {
            userAnswers = new Array(questions.length).fill(null);
        }
    } else {
        // ìƒˆë¡œ ì‹œì‘
        userAnswers = new Array(questions.length).fill(null);
        time = 90 * 60;
        currentQuestion = 0;
        clearState(); // ê¸°ì¡´ ê¸°ë¡ ì‚­ì œ
    }
    
    submitted = false;
    document.getElementById('nav-panel').style.display = 'block';

    if(mode === 'exam'){
        document.getElementById('timer').style.display = 'flex';
        startTimer();
    } else {
        document.getElementById('timer').style.display = 'none';
    }
    
    renderQuestion(currentQuestion);
    renderNavButtons();
}

function returnToStart() {
    if(confirm("ì‹œí—˜ì„ ì¤‘ë‹¨í•˜ê³  ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        clearInterval(timerInterval);
        submitted = false;
        
        // UI ì´ˆê¸°í™”
        document.getElementById('exam-view').style.display = 'none';
        document.getElementById('start-panel').style.display = 'flex';
        document.querySelector('.exam-title').style.display = 'block';
        
        // íƒ€ì´ë¨¸ UI ë¦¬ì…‹
        const timerEl = document.getElementById('timer');
        timerEl.classList.remove('urgent'); 
        document.getElementById('timer-text').textContent = '90:00'; 
        
        document.getElementById('result').innerHTML = '';
        saveState(); // ë‚˜ê°ˆ ë•Œ ìƒíƒœ ì €ì¥ (ì„ íƒ ì‚¬í•­)
    }
}

function startTimer() {
    clearInterval(timerInterval); // ì¤‘ë³µ ë°©ì§€
    timerInterval = setInterval(() => {
        const m = String(Math.floor(time / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        const txt = document.getElementById('timer-text');
        const timerEl = document.getElementById('timer');
        
        if(txt) txt.textContent = `${m}:${s}`;
        
        if(timerEl){
            if(time <= 60*5){ // 5ë¶„ ë¯¸ë§Œ
                timerEl.classList.add('urgent');
            } else {
                timerEl.classList.remove('urgent');
            }
        }
        
        time--;
        
        // 10ì´ˆë§ˆë‹¤ ìë™ ì €ì¥
        if (time % 10 === 0) saveState();

        if (time < 0) {
            clearInterval(timerInterval);
            alert("ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            finishQuiz();
        }
    }, 1000);
}

function renderQuestion(index) {
    const q = questions[index];
    currentQuestion = index;
    const selected = userAnswers[index];
    
    document.getElementById('quiz-container').innerHTML = `
        <div id="question-${index + 1}" class="question-box">
            <h3>ë¬¸ì œ ${index + 1}.</h3>
            <p style="font-size:1.1em; margin-bottom:20px;">${q.question}</p>
            <div class="options">
                ${q.options.map((opt, i) => `
                    <label class="option">
                        <input type="radio" name="option" value="${i}" ${selected === i ? "checked" : ""}>
                        <div class="option-content">
                            <div class="option-index">${i + 1}</div>
                            <div class="option-text">${opt}</div>
                        </div>
                    </label>
                `).join('')}
            </div>
            
            ${mode === 'practice' ? `
                <div style="margin-top:20px;">
                    <button class="btn btn-secondary" onclick="toggleExplanation(${index})">ğŸ’¡ í•´ì„¤ ë³´ê¸°</button>
                    <div id="exp-${index}" class="explanation" style="display:none; margin-top:10px; padding:15px; background:#f0f9ff; border-radius:8px; color:#0369a1;">
                        <strong>í•´ì„¤:</strong><br>${q.explanation || 'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•ŠëŠ” ë¬¸ì œì…ë‹ˆë‹¤.'}
                    </div>
                </div>
            ` : ''}
        </div>
        
        <div class="question-nav" style="display:flex; justify-content:space-between; margin-top:20px;">
            ${index > 0 ? `<button class="btn btn-secondary" onclick="renderQuestion(${index - 1})">ì´ì „ ë¬¸ì œ</button>` : `<div></div>`}
            ${index < questions.length - 1 ? `<button class="btn btn-primary" onclick="saveAnswerAndNext(${index})">ë‹¤ìŒ ë¬¸ì œ</button>` : `<button class="btn btn-primary" onclick="confirmFinish()">ì œì¶œí•˜ê¸°</button>`}
        </div>
    `;

    // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.querySelectorAll('input[name="option"]').forEach(input => {
        input.addEventListener('change', e => {
            userAnswers[index] = parseInt(e.target.value);
            updateNavButton(index);
            saveState(); // ë‹µì•ˆ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥
        });
    });
    
    // í˜„ì¬ ë¬¸ì œ ë²„íŠ¼ í•˜ì´ë¼ì´íŠ¸
    highlightCurrentNavButton(index);
}

function toggleExplanation(index) {
    const exp = document.getElementById(`exp-${index}`);
    if (exp) exp.style.display = exp.style.display === 'block' ? 'none' : 'block';
}

function saveAnswerAndNext(index) {
    // ì´ë¯¸ change ì´ë²¤íŠ¸ì—ì„œ ì €ì¥ë˜ì§€ë§Œ, ì•ˆì „ì„ ìœ„í•´ í•œë²ˆ ë”
    renderQuestion(index + 1);
    window.scrollTo(0, 0); // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
}

function confirmFinish() {
    const answeredCount = userAnswers.filter(a => a !== null).length;
    const remaining = questions.length - answeredCount;
    let msg = "ì •ë§ ì‹œí—˜ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
    if (remaining > 0) {
        msg = `ì•„ì§ í’€ì§€ ì•Šì€ ë¬¸ì œê°€ ${remaining}ê°œ ìˆìŠµë‹ˆë‹¤.\n` + msg;
    }
    
    if (confirm(msg)) {
        finishQuiz();
    }
}

function finishQuiz() {
    clearInterval(timerInterval);
    if (submitted) return;
    submitted = true;
    clearState(); // ì‹œí—˜ ì¢…ë£Œ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ

    // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìˆ¨ê¹€
    document.getElementById('controls').style.display = 'none';
    document.getElementById('quiz-container').style.display = 'none';

    let score = 0;
    const resultContainer = document.getElementById('result');
    resultContainer.innerHTML = '';

    // ê³¼ëª©ë³„ ì ìˆ˜ ê³„ì‚°ì„ ìœ„í•œ ë³€ìˆ˜ (ì •ë³´ì²˜ë¦¬ì‚°ì—…ê¸°ì‚¬ ê¸°ì¤€ 3ê³¼ëª© ê°€ì •, 20ë¬¸ì œì”©)
    const subjectScores = [0, 0, 0];
    const subjectCounts = [0, 0, 0];

    // ê²°ê³¼ HTML ìƒì„±
    let html = `<h2 style="text-align:center; margin-bottom:30px;">ì‹œí—˜ ê²°ê³¼</h2>`;
    
    questions.forEach((q, i) => {
        const correct = q.answer;
        const user = userAnswers[i];
        const isAnswered = (user !== undefined && user !== null);
        const isCorrect = isAnswered && (user + 1) === correct;
        
        const subjectIndex = Math.floor(i / 20);
        if(subjectIndex < 3) subjectCounts[subjectIndex]++;
        
        if (isCorrect) {
            score++;
            if(subjectIndex < 3) subjectScores[subjectIndex]++;
        }

        // í‹€ë¦° ë¬¸ì œë§Œ ë³´ì—¬ì£¼ê±°ë‚˜, ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë³´ì—¬ì£¼ê¸° (ì—¬ê¸°ì„  ì „ì²´ ìš”ì•½)
        html += `
        <div class="question-box" style="border-left: 5px solid ${isCorrect ? '#22c55e' : '#ef4444'};">
            <div style="font-weight:bold; margin-bottom:8px;">ë¬¸ì œ ${i + 1}.</div>
            <div style="color:#64748b; margin-bottom:4px;">${q.question}</div>
            <div style="margin-top:10px; font-size:0.95em;">
                ë‚˜ì˜ ë‹µ: <span style="color:${isCorrect ? 'green' : 'red'}">${isAnswered ? (user+1) + '. ' + q.options[user] : 'ë¯¸ì‘ë‹µ'}</span>
                ${!isCorrect ? `<br>ì •ë‹µ: <span style="color:green; font-weight:bold;">${correct}. ${q.options[correct-1]}</span>` : ''}
            </div>
            <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #e2e8f0; color:#475569; font-size:0.9em;">
                ğŸ’¡ í•´ì„¤: ${q.explanation || 'í•´ì„¤ ì—†ìŒ'}
            </div>
        </div>
        `;
    });

    // ì ìˆ˜ ê³„ì‚°
    const totalScore = Math.round((score / questions.length) * 100);
    const subjectPass = subjectScores.every((s, i) => {
        // ê³¼ëª©ë‹¹ ë¬¸ì œê°€ ì—†ìœ¼ë©´ íŒ¨ìŠ¤ (ì˜ˆì™¸ì²˜ë¦¬)
        if(subjectCounts[i] === 0) return true;
        return (s / subjectCounts[i]) * 100 >= 40;
    });
    const isPassed = subjectPass && totalScore >= 60;

    const summaryHtml = `
        <div style="text-align:center; padding:30px; background:#f8fafc; border-radius:16px; margin-bottom:30px;">
            <div style="font-size:1.2rem; color:#64748b;">ì´ì </div>
            <div style="font-size:3rem; font-weight:900; color:${totalScore >= 60 ? '#1e88e5' : '#ef4444'}">${totalScore}ì </div>
            <div style="margin-top:10px; font-size:1.2rem; font-weight:bold;">
                ${isPassed ? "<span style='color:green'>ğŸ‰ í•©ê²©ì…ë‹ˆë‹¤!</span>" : "<span style='color:red'>ì•„ì‰½ê²Œë„ ë¶ˆí•©ê²©ì…ë‹ˆë‹¤.</span>"}
            </div>
        </div>
        <div style="margin-bottom:30px; text-align:center;">
            <button class="btn btn-primary" onclick="location.reload()">ë‹¤ì‹œ í’€ê¸°</button>
            <a href="/select" class="btn btn-secondary" style="text-decoration:none;">ë‹¤ë¥¸ ê³¼ëª© ì„ íƒ</a>
        </div>
    `;

    resultContainer.innerHTML = summaryHtml + html;

    // ì„œë²„ ì „ì†¡ (ì‹œí—˜ ëª¨ë“œì¼ ë•Œë§Œ)
    if (mode === 'exam') {
        fetch("/api/submit", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                answers: userAnswers,
                mode: mode
            })
        }).catch(err => console.error("ì œì¶œ ì‹¤íŒ¨:", err));
    }
}

function renderNavButtons() {
    const nav = document.getElementById('question-buttons');
    nav.innerHTML = '';
    questions.forEach((_, i) => {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.onclick = () => {
            renderQuestion(i);
            // ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ ë²„íŠ¼ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            if(window.innerWidth <= 900) {
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        };
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        if (userAnswers[i] !== null) btn.classList.add('answered');
        if (i === currentQuestion) btn.classList.add('current');
        
        nav.appendChild(btn);
    });
}

function updateNavButton(index) {
    const nav = document.getElementById('question-buttons');
    const btn = nav.children[index];
    if (btn && userAnswers[index] !== null) {
        btn.classList.add('answered');
    }
}

function highlightCurrentNavButton(index) {
    const nav = document.getElementById('question-buttons');
    Array.from(nav.children).forEach(btn => btn.classList.remove('current'));
    if (nav.children[index]) {
        nav.children[index].classList.add('current');
    }
}

// ë°ì´í„° ë¡œë“œ
fetch(`/api/questions?subject=${SUBJECT}&version=${VERSION}`)
    .then(res => res.json())
    .then(data => {
        questions.push(...data);
        console.log("ë¬¸ì œ ë¡œë“œ ì™„ë£Œ:", questions.length);
    })
    .catch(err => {
        console.error("ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
        document.getElementById('quiz-container').innerHTML = "<p style='text-align:center; color:red;'>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.</p>";
    });
</script>
</body>
</html>